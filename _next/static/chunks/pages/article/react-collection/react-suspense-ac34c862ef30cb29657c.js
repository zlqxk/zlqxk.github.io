(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[821],{8420:function(n,e,r){"use strict";r.d(e,{Z:function(){return w}});var s=r(6311),t=r(2472),o=r.n(t),a=r(9980),l=r.n(a),u=r(637),i=new(l())({highlight:function(n,e){var r=i.utils.escapeHtml(n);return e&&u.Z.getLanguage(e)&&(r=u.Z.highlight(e,n,!0).value),'<pre class="hljs"><code>'.concat(r,"</code></pre>")}}),c=i,p=r(2809),f=r(7294),d=r(3518),h=r.n(d),m=r(4184),g=r.n(m),k=r(5893),b=function(n){var e=n.visible,r=n.onClose,s=n.src;return(0,k.jsx)("div",{className:g()(h().imgPreview,(0,p.Z)({},h().visible,e)),onClick:r,children:(0,k.jsx)("img",{src:s})})},S=r(9008),w=(r(7460),function(n){var e=n.content,r=n.pageInfo,t=function(){var n=(0,f.useState)(!1),e=n[0],r=n[1],s=(0,f.useState)(""),t=s[0],o=s[1],a=(0,f.useRef)(null);return(0,f.useEffect)((function(){var n,e,s=null!==(n=null===(e=a.current)||void 0===e?void 0:e.getElementsByTagName("img"))&&void 0!==n?n:[];Array.from(s).forEach((function(n){n.onclick=function(n){n.target instanceof HTMLImageElement&&o(n.target.src),r(!0)}}))}),[]),[a,e,t,r]}(),a=(0,s.Z)(t,4),l=a[0],u=a[1],i=a[2],p=a[3];return(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)(S.default,{children:[(0,k.jsx)("title",{children:r.title}),(0,k.jsx)("meta",{name:"description",content:r.subtitle})]}),(0,k.jsx)(b,{visible:u,src:i,onClose:function(){return p(!1)}}),(0,k.jsx)("article",{ref:l,className:o().article,dangerouslySetInnerHTML:{__html:c.render(e)}})]})})},3733:function(n,e,r){"use strict";r.r(e),r.d(e,{default:function(){return o}});r(7294);var s=r(8420),t=r(5893),o=function(){return(0,t.jsx)(s.Z,{content:"# React Suspense \u89e3\u6790\n\n6 \u6708 22, 2022 \u2022 \u2615\ufe0f\u2615\ufe0f\u2615\ufe0f 20 min read\n\n\u73b0\u5728\u6211\u4eec\u4ee3\u7801\u4e2d\u6709\u300c\u526f\u4f5c\u7528\u300d\u7684\u884c\u4e3a\u4f8b\u5982\u5f02\u6b65\u8bf7\u6c42\uff0c\u90fd\u662f\u653e\u5728 useEffect \u4e2d\u5904\u7406\u7684\uff0c\u800c `Suspense` \u901a\u5e38\u53ea\u662f\u642d\u914d `React Lazy` \u6765\u5b9e\u73b0\u4ee3\u7801\u5206\u5272\u3002\u4f46\u662f\u5728\u672a\u6765\uff0c\u6211\u4eec\u6216\u8bb8\u53ef\u4ee5\u5b8c\u5168\u4f9d\u8d56 `Suspense`\uff0c\u800c\u4e0d\u518d\u5173\u5fc3\u4ec0\u4e48\u6837\u7684\u4ee3\u7801\u662f\u6709\u526f\u4f5c\u7528\u7684\u3002\n\n## Suspense \u5982\u4f55\u4f7f\u7528\n\n\u6211\u4eec\u901a\u8fc7\u5728\u7ec4\u4ef6\u91cc\u629b\u51fa\u4e00\u4e2a `Promise` \u7684\u5f02\u5e38\uff0c`Suspense` \u4f1a\u5e2e\u6211\u4eec\u6355\u83b7\u5230\u8fd9\u4e2a\u5f02\u5e38\uff0c\u7136\u540e\u663e\u73b0 fallback \u7684\u5185\u5bb9\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u7ec4\u4ef6\u6c38\u8fdc\u90fd\u662f\u5728\u629b\u51fa `Promise` \u7684\u5f02\u5e38\uff0c\u6240\u4ee5\u6211\u4eec\u7684\u9875\u9762\u4f1a\u4e00\u76f4\u5c55\u793a loading...\n\n```tsx\nfunction ProfilePage() {\n  return (\n    <Suspense fallback={<h1>loading...</h1>}>\n      <ProfileDetails />\n    </Suspense>\n  )\n}\n\nconst promise = new Promise(() => {})\n\nfunction ProfileDetails() {\n  throw promise\n  return <h1>Hello World</h1>\n}\n```\n\n![react-suspense_1](/react-suspense/react-suspense_1.jpg)\n\n\u6211\u4eec\u58f0\u660e\u4e00\u4e2a done \u7684\u53d8\u91cf\uff0cfalse \u7684\u65f6\u5019\u629b\u51fa\u5f02\u5e38\u5c55\u793a fallback \u7684\u5185\u5bb9\uff0c\u7b49\u5f02\u6b65\u6267\u884c\u7ed3\u675f\u540e\u8bbe\u7f6e\u4e3a true\uff0c\u8fd9\u65f6\u5019\u9875\u9762\u5c55\u793a Hello World\u3002\n\n```tsx\nfunction ProfilePage() {\n  return (\n    <Suspense fallback={<h1>loading...</h1>}>\n      <ProfileDetails />\n    </Suspense>\n  )\n}\n\nlet done = false\n\nconst promise = new Promise((resolve) => {\n  setTimeout(() => {\n    done = true\n    resolve()\n  }, 1000)\n})\n\nfunction ProfileDetails() {\n  if (!done) {\n    throw promise\n  }\n  return <h1>Hello World</h1>\n}\n```\n\n\u901a\u8fc7\u8fd9\u4e2a\u601d\u8def\uff0c\u6211\u4eec\u53ef\u4ee5\u5c01\u88c5\u4e00\u4e2a\u901a\u7528\u7684\u51fd\u6570\uff0c\u4f20\u5165\u4e00\u4e2a `promise`\uff0c\u5728 promise resolve \u4e4b\u524d\u629b\u51fa\u5f02\u5e38\uff0cresolve \u4ee5\u540e\u8fd4\u56de\u6b63\u5e38\u7ed3\u679c\u3002\n\n```ts\nfunction wrapPromise(promise) {\n  let status = 'pending'\n  let result\n  let suspender = promise.then(\n    (r) => {\n      status = 'success'\n      result = r\n    },\n    (e) => {\n      status = 'error'\n      result = e\n    }\n  )\n  return {\n    read() {\n      if (status === 'pending') {\n        throw suspender\n      } else if (status === 'error') {\n        throw result\n      } else if (status === 'success') {\n        return result\n      }\n    },\n  }\n}\n```\n\n\u8fd9\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u50cf\u5199\u4e00\u4e2a\u540c\u6b65\u7684\u4ee3\u7801\u4e00\u6837\u6765\u8bf7\u6c42\u6570\u636e\uff0c\u5728\u6570\u636e\u8bf7\u6c42\u56de\u6765\u4e4b\u524d\u5c55\u793a `Suspense` \u7684 fallback \u5185\u5bb9\uff0c\u6570\u636e\u8bf7\u6c42\u56de\u6765\u4ee5\u540e\u5c55\u793a\u6b63\u5e38\u7684\u6570\u636e\u3002\n\n```tsx\nfunction fetchProfileData() {\n  // fetchUser \u662f\u4e00\u4e2a\u666e\u901a\u7684\u5f02\u6b65\u8bf7\u6c42\n  let userPromise = fetchUser()\n  // \u4f7f\u7528 wrapPromise \u5305\u88c5\n  return wrapPromise(userPromise)\n}\n\nconst resource = fetchProfileData()\n\nfunction ProfilePage() {\n  return (\n    <Suspense fallback={<h1>loading...</h1>}>\n      <ProfileDetails />\n    </Suspense>\n  )\n}\n\nfunction ProfileDetails() {\n  console.log('ProfileDetails render')\n  const user = resource.read()\n  console.log('user: ', user)\n\n  return <h1>{user.name}</h1>\n}\n```\n\n![react-suspense_2](/react-suspense/react-suspense_2.gif)\n\n## Suspense \u539f\u7406\n\n\u5728\u77e5\u9053\u4e86\u5982\u4f55\u4f7f\u7528 `Suspense` \u4ee5\u540e\uff0c\u6211\u4eec\u4e0d\u7981\u6709\u4e24\u4e2a\u7591\u95ee\u3002\n\n- react \u662f\u5982\u4f55\u6355\u83b7\u5230\u629b\u51fa\u7684 Promise\u3002\n- react \u662f\u5982\u4f55\u5728 Promise \u6267\u884c\u5b8c\u6210\u4ee5\u540e\u91cd\u65b0\u5c55\u793a\u6b63\u786e\u7684\u5185\u5bb9\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e00\u6bb5\u7b80\u5355\u7684\u4ee3\u7801\u6765\u89e3\u91ca\u4e0a\u8ff0\u4e24\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u901a\u8fc7 try... catch... \u6765\u6355\u83b7\u5f02\u5e38\uff0c\u7136\u540e\u5728 catch \u7684\u903b\u8f91\u4e2d\u6267\u884c\u8fd9\u4e2a promise\uff0c\u5728\u56de\u8c03\u4e2d\u91cd\u65b0\u6267\u884c render \u65b9\u6cd5\uff0c\u8fd9\u65f6\u5019 done \u5df2\u7ecf\u53d8\u6210 true\uff0c\u5c31\u53ef\u4ee5\u6b63\u5e38\u6267\u884c render \u4e86\u3002\n\n```tsx\nlet done = false\n\nconst promise = new Promise((resolve) => {\n  setTimeout(() => {\n    done = true\n    resolve()\n  }, 1000)\n})\n\nfunction render() {\n  try {\n    if (!done) {\n      console.log('loading...')\n      throw promise\n    }\n    console.log('render done')\n  } catch (error) {\n    promise.then((res) => render())\n  }\n}\n\nrender()\n```\n\n\u540c\u6837\u7684\uff0creact \u4e5f\u4f7f\u7528\u4e86\u4e00\u6837\u7684\u601d\u8def\uff0c\u8ba9\u6211\u4eec\u5148\u770b\u4e00\u4e0b react \u6267\u884c\u7684\u5927\u4f53\u6d41\u7a0b\uff0c\u7136\u540e\u518d\u9010\u6b65\u770b\u4e0b\u5177\u4f53\u5b9e\u73b0\u3002\n\n![react-suspense_3](/react-suspense/react-suspense_3.jpg)\n\n### 1. \u6355\u83b7\u5f02\u5e38\n\n\u5728\u7ec4\u4ef6 render \u7684\u8fc7\u7a0b\u4f7f\u7528 try... catch... \u6355\u83b7 render \u9636\u6bb5\u629b\u51fa\u7684\u5f02\u5e38\u3002\n\n```tsx\ndo {\n  try {\n    // \u7ec4\u4ef6 render \u6d41\u7a0b\n    workLoopSync()\n    break\n  } catch (thrownValue) {\n    handleError(root, thrownValue)\n  }\n} while (true)\n```\n\n\u5728\u6e32\u67d3\u7684\u8fc7\u7a0b\u4e2d\u7b2c\u4e00\u6b21\u9047\u5230 `Suspense` \u7ec4\u4ef6\u4f1a\u6b63\u5e38\u6e32\u67d3\u5176\u5b50\u5b59\u7ed3\u70b9\u3002\n\n```tsx\n// showFallback \u4e3a false\nif (showFallback) {\n  // \u6e32\u67d3fallback\n} else {\n  return mountSuspensePrimaryChildren(workInProgress, nextPrimaryChildren, renderLanes)\n}\n```\n\n\u5728 render \u5230\u5b50\u7ec4\u4ef6\u65f6 try... catch... \u6355\u83b7\u5230\u629b\u51fa\u7684\u5f02\u5e38\uff0c\u901a\u8fc7\u5224\u65ad\u6355\u83b7\u7684\u5f02\u5e38\u6709\u6ca1\u6709 then \u65b9\u6cd5\u6765\u5224\u65ad\u662f\u5426\u8fdb\u5165 `Suspense` \u7684\u903b\u8f91\uff0c\n\n```tsx\nif (value !== null && typeof value === 'object' && typeof value.then === 'function') {\n  // \u662f\u5426\u9700\u8981 Suspense \u63a5\u7ba1\n}\n```\n\n### 2. \u5904\u7406 Suspense \u7ec4\u4ef6\n\n\u5982\u679c\u662f\u9700\u8981 `Suspense` \u63a5\u7ba1\uff0c\u5219\u4f1a\u4f9d\u6b21\u6267\u884c\u4ee5\u4e0b\u4e09\u6b65\uff1a\n\n1. \u67e5\u627e\u629b\u51fa\u5f02\u5e38\u7ec4\u4ef6\u6700\u8fd1\u7684 `Suspense`\u3002\n2. \u5bf9 `Suspense` \u505a\u6807\u8bb0\uff0c\u518d\u6b21 render \u5219\u5c55\u793a fallback \u7684\u5185\u5bb9\u3002\n3. \u5c06\u6355\u83b7\u7684 Promise \u6302\u8f7d\u5230 `Suspense` \u4e0a\u3002\n\n```tsx\n// \u67e5\u627e\u5f53\u524d\u629b\u51fa\u5f02\u5e38\u7684\u7ec4\u4ef6\u6700\u8fd1\u7684 Suspense\nconst suspenseBoundary = getNearestSuspenseBoundaryToCapture(returnFiber)\n\n// \u7ed9\u67e5\u627e\u5230\u7684Suspense\u505a\u4e00\u4e2a\u6807\u8bb0\nmarkSuspenseBoundaryShouldCapture(suspenseBoundary, returnFiber, sourceFiber, root, rootRenderLanes)\n\n// \u5c06\u6355\u83b7\u7684\u5f02\u5e38\u6302\u8f7d\u5230Suspense\u7684updateQueue\u4e0a\nattachRetryListener(suspenseBoundary, root, wakeable, rootRenderLanes)\n```\n\n\u5728\u6267\u884c\u5b8c\u4e0a\u8ff0\u4e09\u6b65\u4ee5\u540e\u4f1a\u91cd\u65b0\u6267\u884c\u4e00\u904d render\u3002\n\n```tsx\ncompleteUnitOfWork(erroredWork)\n```\n\n### 3. \u5c55\u793a fallback\n\n\u5728\u6267\u884c\u7b2c\u4e8c\u6b21 render \u7684\u65f6\u5019\u7531\u4e8e `Suspense` \u5df2\u7ecf\u88ab\u6253\u6807\u8bb0\uff0c\u8bf4\u660e\u5df2\u7ecf\u6355\u83b7\u5230\u9519\u8bef\u4e86\uff0c\u6b64\u65f6\u5c55\u793a fallback \u7684\u5185\u5bb9\uff0c\u56e0\u4e3a\u4e0d\u518d\u6e32\u67d3\u6709\u5f02\u5e38\u7684\u5b50\u7ec4\u4ef6\uff0c\u6240\u4ee5 render \u53ef\u4ee5\u7ee7\u7eed\u5411\u4e0b\u6267\u884c\u3002\n\n```tsx\n// showFallback \u4e3a true\nif (showFallback) {\n  const fallbackFragment = mountSuspenseFallbackChildren(\n    workInProgress,\n    nextPrimaryChildren,\n    nextFallbackChildren,\n    renderLanes\n  )\n\n  return fallbackFragment\n}\n```\n\n### 4. \u6267\u884c promise\n\n\u5728\u6700\u540e\u7684 `commit` \u9636\u6bb5\uff0c\u6267\u884c\u5728 `Suspense` \u6302\u8f7d\u7684 promise\u3002\n\n```tsx\nfunction attachSuspenseRetryListeners(finishedWork: Fiber) {\n  const wakeables: Set<Wakeable> | null = (finishedWork.updateQueue: any);\n  if (wakeables !== null) {\n    wakeables.forEach(wakeable => {\n      const retry = resolveRetryWakeable.bind(null, finishedWork, wakeable);\n      if (!retryCache.has(wakeable)) {\n        // \u5173\u952e\u4ee3\u7801\n        wakeable.then(retry, retry);\n      }\n    });\n  }\n}\n```\n\n### 5. \u91cd\u65b0 render\n\n\u6700\u540e\u5f53 promise resolve \u7ed3\u675f\u540e\u4f1a\u91cd\u65b0 render `Suspense` \u7684\u5b50\u5b59\u7ec4\u4ef6\uff0c\u8fd9\u65f6\u6570\u636e\u8bf7\u6c42\u5df2\u7ecf\u5b8c\u6210\uff0c\u5b50\u5b59\u7ec4\u4ef6\u4e0d\u518d\u629b\u51fa\u5f02\u5e38\uff0c\u9875\u9762\u6b63\u5e38\u6e32\u67d3\u6709\u6570\u636e\u7684\u7ed3\u679c\u3002\n\n## \u603b\u7ed3\n\n`Suspense` \u662f React \u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c`Suspense` \u7684\u5b58\u5728\u6216\u8bb8\u4f1a\u6539\u53d8\u6211\u4eec\u672a\u6765\u6570\u636e\u8bf7\u6c42\u7684\u65b9\u5f0f\u3002\n",pageInfo:{title:"React Suspense \u89e3\u6790",subtitle:"React Suspense \u4f7f\u7528\u548c\u539f\u7406\u89e3\u6790"}})}},9066:function(n,e,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/article/react-collection/react-suspense",function(){return r(3733)}])},3518:function(n){n.exports={imgPreview:"ImgPreview_imgPreview__2OxIp",visible:"ImgPreview_visible__37B3E"}},2472:function(n){n.exports={article:"post_article__2Kkhj",anchor:"post_anchor__3OJU8",translation:"post_translation__2cS_6"}}},function(n){n.O(0,[800,774,888,179],(function(){return e=9066,n(n.s=e);var e}));var e=n.O();_N_E=e}]);